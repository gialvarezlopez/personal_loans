<style>
.amounts{
    font-size:14px;
    font-weight: 700;
    color: #34825F;
}

.titleCurrency{
    font-size: 18px !important;
}

.actionFreezed{
    color: #96271b;
    font-weight: 700;
}

.actionPaid{
    color: #366d54;
    font-weight: 700;
}

#total, #totalPaid, #pending{
    color: green;
}
.pending{
    background: #EC971F;
    color: #fff !important;
}
.nothingPending{
    background:#00A65A;
    color: #fff !important;
}

.labelCurrency{
    display:inline-block;
    width: 150px;
    font-size: 19px;
}
.loanCompleted{
    color: #00A65A;
    font-size:20px;
    font-weight: 700;
    margin-bottom: 20px;
    text-align: center;
}

.widthAuto {
   width: auto !important;
}
</style>

<div class="row">
    <div class="col-md-4"><span><i class="fa fa-money" aria-hidden="true"></i> {% trans %}loan_table_rate_payments_history{% endtrans %}: <span class="badge"></span></span></div>
    <div class="col-md-4 col-md-offset-4 text-right">
        <form class="form-inline"> 
            <div class="form-group">
                <a class="" href="{{ path('loanpayment_quotasHistory') }}?loaId={{loan.loaId}}">{% trans %}loan_table_rate_payments_full_history{% endtrans %}</a>
            </div>
        </form>
    </div>
</div>
<hr>
<input type='hidden' value="{{ loan.loaRecurringDayPayment }}" id='curringDaySelected'>

{% set hasPaymentDone = srv_Loans.getTotalAmountPaid(loan.loaId) %}

{% if arr and hasPaymentDone > 0 %}
                        <table class="table table-striped display nowrap" id="tablePayments" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>{% trans %}loan_table_payments_payment_date{% endtrans %}</th>
                                        <th>{% trans %}loan_table_payments_paid_date{% endtrans %}</th>
                                        <th>{# {% trans %}loan_table_rate_payments_paid_amount{% endtrans %}#} Monto pagado</th>
                                        <th>{% trans %}loan_table_rate_payments_rate{% endtrans %}</th>
                                        <th>{% trans %}loan_msg_paid_capital{% endtrans %}</th>
                                        <th>{% trans %}loan_msg_paid_interest{% endtrans %}</th>
                                        <th>{% trans %}loan_table_rate_payments_status{% endtrans %}</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set counter = 0 %}
                                    {% set totalToPay = 0 %}
                                    {% set totalPaid = 0  %}
                                    {% set totalInterest = 0  %}
                                    {% set totalAmount = 0  %}
                                    {% for item in arr %}
                                        {% set counter =  counter + 1 %}

                                        {% if item.lpa_paid_capital or item.lpa_total_amount_paid %}
                                            {% set readonly = "readonly='readonly'" %}
                                            {% set done = "done" %} 
                                        {% else %}
                                            {% set readonly = "" %}
                                            {% set done = "" %}
                                        {% endif %}
                                        <tr id="tr_{{ counter }}" class="{{done}}">
                                          
                                            {# check if the payment has additional payment #}
                                            {% set payment_add = false %}
                                            {% if item.lpa_hash != "" %}
                                                {% set payment_add = srv_Loans.getAdditionalPaymentByHash(item.lpa_hash) %}
                                            {% endif %}

                                            <td>{{ counter }}</td>
                                            <td>
                                                {% if counter > 1 %}
                                                    {{ item.lpa_max_payment_date|date_modify("-"~ (loan.loaRecurringDayPayment - 1 ) ~" day")|date("Y-m-d") }}
                                                {% else %}
                                                    N/A
                                                {% endif %}    
                                                -
                                                <span class="maxDate">{{ item.lpa_max_payment_date }}</span>
                                            </td>
                                            
                                            
                                            <td>{% if item.lpa_paid_date  %} {{  item.lpa_paid_date }} {% else %} {% trans %}general_msg_pending{% endtrans %} {% endif %}</td>
                                            <td>
                                                    {% if payment_add|length > 0 %}
                                                        B1 =
                                                    {% endif %}
                                                    
                                                   <span class="label label-default amounts"> ${{ item.lpa_total_amount_paid|number_format(2, '.', ',') }}</span>
                                                    {% set totalAmount =  totalAmount + item.lpa_total_amount_paid %}

                                                    {% if payment_add|length > 0 %}
                                                        {% set totalAmount =  totalAmount + payment_add[0]["lpa_total_amount_paid"] %}
                                                       <div style="margin-top: 10px"> B2 = <span class="label label-default amounts"> ${{ payment_add[0]["lpa_total_amount_paid"]|number_format(2, '.', ',') }}</span> </div>
                                                    {% endif %}
                                            </td>
                                            <td>
                                                {% if payment_add|length > 0 %}
                                                    B1 =
                                                {% endif %}

                                                {% if item.lpa_total_amount_paid > 0 %}
                                                    {{ item.lpa_current_rate_interest }}
                                                {% else %}
                                                    {% set nextRate =  item.lpa_current_rate_interest * (item.lpa_multiplied_interest_by) %} 
                                                    {{ nextRate }}
                                                {% endif %}
                                                %
                                                <br>
                                                {% if payment_add|length > 0 %}
                                                    <div style="margin-top: 10px">B2 = {{ payment_add[0]["lpa_current_rate_interest"] }}%</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if payment_add|length > 0 %}
                                                    B1 =
                                                {% endif %}
                                                <span class="label label-success amounts">
                                                {% set totalPaid = totalPaid + item.lpa_paid_capital %}
                                                ${{ item.lpa_paid_capital|number_format(2, '.', ',')  }}</span>

                                                {% if payment_add|length > 0 %}
                                                    {% set totalPaid = totalPaid + payment_add[0]["lpa_paid_capital"] %}
                                                    <div style="margin-top: 10px">B2 = <span class="label label-success amounts">${{ payment_add[0]["lpa_paid_capital"] }}</span></div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if payment_add|length > 0 %}
                                                    B1 =
                                                {% endif %}
                                                <span class="label label-success amounts">
                                                {% set totalInterest = totalInterest + item.lpa_paid_rate_interest %}
                                                ${{ item.lpa_paid_rate_interest|number_format(2, '.', ',')  }}</span>

                                                {% if payment_add|length > 0 %}
                                                    {% set totalInterest = totalInterest + payment_add[0]["lpa_paid_rate_interest"] %}
                                                    <div style="margin-top: 10px">B2 = <span class="label label-success amounts">${{ payment_add[0]["lpa_paid_rate_interest"]|number_format(2, '.', ',') }}</span></div>
                                                {% endif %}
                                            </td>
                                            <td id="currentPiriod">
                                                {% if item.lpa_total_amount_paid > 0 %}
                                                    {# <i class="fa fa-thumbs-o-up" aria-hidden="true"></i> #}
                                                    {% trans %}loan_table_rate_payments_node{% endtrans %} 
                                                {% else %}
                                                    {% trans %}general_msg_pending{% endtrans %}
                                                {% endif %} 
                                            </td>
                                            <td></td>
                                        </tr>
                                       
                                    {% endfor %}
                                    </tbody>
                                    {#
                                    <tfoot>
                                        <tr>
                                            <th colspan="3" class="text-center">Total</th>
                                            <th><span class="label label-default amounts">${{ totalAmount|number_format(2, '.', ',') }}</span></th>
                                            <th></th>
                                            <th><span class="label label-success amounts">${{ totalPaid|number_format(2, '.', ',') }}</span></th>
                                            <th><span class="label label-success amounts">${{ totalInterest|number_format(2, '.', ',') }}</span></th>
                                            <th></th>
                                            <th></th>
                                        </tr>
                                    </tfoot>
                                    #}
                                
                        </table>

                        <div>
                                {% set additionalAmounts = srv_Loans.getTotalAdditionalAmounts(loan.loaId) %}

                                {% set pending =  srv_Loans.checkDeadLineToPay( loan.loaRateInterest, loan.loaRecurringDayPayment, loan.loaDeadline|date('Y-m-d'), srv_TimeZone.getNameTimeZone() ) %}
                                {% if pending %}
                                    {% set rate = pending.rate %}   

                                {% else %}
                                    {% set rate = loan.loaRateInterest %}     
                                {% endif %}

                                {% set paidAmount = srv_Loans.checkPaymentsPerLoan(loan.loaId) %}
                                {% if paidAmount %}
                                    {% set money = ((loan.loaAmount + additionalAmounts) - paidAmount[0]['paidCapital'])|abs %}
                                {% else %}
                                    {% set money = (loan.loaAmount + additionalAmounts)|abs %}
                                {% endif %}
                                
                                <hr>
                                <h3 class=""><span class="labelCurrency">{% trans %}loan_table_rate_payments_node_total{% endtrans %}:</span> <span id="total" class="label label-default">${{ totalAmount|number_format(2, '.', ',') }}</span></h3>
                                <h3 class=""><span class="labelCurrency">{% trans %}loan_msg_paid_capital{% endtrans %}:</span> <span id="total" class="label label-default">${{ totalPaid|number_format(2, '.', ',') }}</span></h3>
                                <h3 class=""><span class="labelCurrency">{% trans %}loan_msg_paid_interest{% endtrans %}:</span> <span id="total" class="label label-default">${{ (totalAmount - totalPaid)|number_format(2, '.', ',') }}</span></h3>
                                {% if showResume %}
                                <div>
                                    <h3 class=""><span class="labelCurrency">{% trans %}loan_msg_pending_to_pay{% endtrans %}: </span>
                                    <span class="amountsX">
                                        ( ${{ (money)|number_format(2, '.', ',') }} x {{rate}}%  ) + ${{ money|number_format(2, '.', ',') }} = 

                                        {% set pending = ((money) * (rate/100) + (money))|number_format(2, '.', ',') %}
                                        {% if pending > 0 %}
                                            {% set stalabel = "pending" %}
                                        {% else %}
                                            {% set stalabel = "nothingPending" %}
                                        {% endif %}
                                        <span class="label label-default {{stalabel}}">${{  pending }}</span>
                                        </span>
                                    </h3>    
                                </div>
                                
                                {% endif %}
                                <hr>
                        </div>
{% else %}
    {# <div class="well alert alert-info"><strong>Info!</strong> no se ha hecho ningun pago <!-- There are not payments done --></div> #}
    {% set tamount = loan.loaAmount %}
    {% set additionalAmounts = srv_Loans.getTotalAdditionalAmounts(loan.loaId) %}
    {% if additionalAmounts > 0 %}
          {% set tamount = tamount + additionalAmounts %}
    {% endif %}
    <div class="panel panel-info">
        <div class="panel-heading"><i class="fa fa-money" aria-hidden="true"></i> No se ha hecho ningun pago!</div>
        <div class="panel-body">
            <strong>Monto total: ${{ tamount|number_format(2, '.', ',') }}</strong> 
        </div>
    </div>
    
{% endif %}